@using BTCPayServer.Abstractions.Extensions
@using BTCPayServer.Abstractions.Models
@using BTCPayServer.Plugins.NairaCheckout.Data
@using BTCPayServer.Plugins.NairaCheckout.ViewModels
@model MavapaySettingViewModel
@{

    ViewData.SetLayoutModel(new LayoutModel("Mavapay-Settings", "Mavapay Settings") { ActiveCategory = "Mavapay" });
}

<form method="post" asp-action="MavapayCheckoutSettings">
    <div class="sticky-header d-flex align-items-center justify-content-between">
        <h2>Split Payment Settings</h2>
        <button type="submit" class="btn btn-primary" id="Edit" value="Save Changes">Save Changes</button>
    </div>

    <partial name="_StatusMessage" />

    <div class="row">
        <div class="col-xl-10 col-xxl-constrain">
            <div class="form-group d-flex align-items-center">
                <input asp-for="EnableSplitPayment" type="checkbox" class="btcpay-toggle me-3" id="enableSplit" />
                <div class="text-secondary">
                    <label asp-for="EnableSplitPayment" for="enableSplit" class="form-label mb-0 me-1"></label>
                    <span text-translate="true">(Automatically split payments from settled invoices)</span>
                </div>
            </div>

            <div id="splitSection" class="d-none">

                <div class="alert alert-info mt-3">
                    <h6 class="alert-heading mb-2">
                        <i class="fa fa-info-circle"></i> How Split Payments Work
                    </h6>
                    <p class="mb-2"><strong>Split payments will be processed for:</strong></p>
                    <ul class="mb-2">
                        <li><strong>Matching currency invoices:</strong> Invoices created in <strong id="payoutCurrencyMatch">NGN</strong> → paid out in <strong id="payoutCurrencyMatch2">NGN</strong></li>
                        <li><strong>USD invoices:</strong> Invoices created in <strong>USD</strong> → converted and paid out in <strong id="payoutCurrencyUSD">NGN</strong> using Mavapay exchange rates</li>
                    </ul>
                    <p class="mb-0">
                        <span class="ms-2 small">
                            Invoices in other currencies (EUR, GBP) or mismatched currencies (e.g., KES invoice when payout is NGN) will <strong>not</strong> trigger split payments.
                        </span>
                    </p>
                </div>

                <div class="mb-3 w-100 w-md-50">
                    <label class="form-label">Split Percentage (%)</label>
                    <input asp-for="SplitPayment.SplitPercentage" type="number" min="1" max="100" class="form-control" />
                </div>
                <div class="mb-3 w-100 w-md-50">
                    <label class="form-label">Payout Currency</label>
                    <select asp-for="SplitPayment.Currency" class="form-select" id="currencySelect">
                        <option value="NGN">NGN (Nigerian Naira)</option>
                        <option value="KES">KES (Kenyan Shilling)</option>
                        <option value="ZAR">ZAR (South African Rand)</option>
                    </select>
                </div>
                <div id="ngnSection" class="d-none">
                    <h5>NGN Account Details</h5>
                    <div class="mb-3">
                        <label>Bank</label>
                        <select asp-for="SplitPayment.NGNBankCode" asp-items="Model.SplitPayment.NGNBanks" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label>Account Number</label>
                        <input asp-for="SplitPayment.NGNAccountNumber" maxlength="10" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label>Account Name</label>
                        <input asp-for="SplitPayment.NGNAccountName" class="form-control" />
                    </div>
                </div>
                <div id="kesSection" class="d-none">
                    <h5>KES Account Details</h5>
                    <div class="mb-3">
                        <label>Payout Method</label>
                        <select asp-for="SplitPayment.KESMethod" asp-items="Model.SplitPayment.KESPaymentMethod" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label>Till/Bill/Phone Number</label>
                        <input asp-for="SplitPayment.KESIdentifier" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label>Account Name</label>
                        <input asp-for="SplitPayment.KESAccountName" class="form-control" />
                    </div>
                </div>
                <div id="zarSection" class="d-none">
                    <h5>ZAR Account Details</h5>
                    <div class="mb-3">
                        <label>Bank</label>
                        <select asp-for="SplitPayment.ZARBank" asp-items="Model.SplitPayment.ZARBanks" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label>Account Number</label>
                        <input asp-for="SplitPayment.ZARAccountNumber" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label>Account Name</label>
                        <input asp-for="SplitPayment.ZARAccountName" class="form-control" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>



@section PageFootContent {
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const enableSplit = document.getElementById("enableSplit");
            const splitSection = document.getElementById("splitSection");

            const currencySelect = document.getElementById("currencySelect");
            const ngnSection = document.getElementById("ngnSection");
            const kesSection = document.getElementById("kesSection");
            const zarSection = document.getElementById("zarSection");

            function toggleSplit() {
                splitSection.classList.toggle("d-none", !enableSplit.checked);
            }

            function toggleCurrency() {
                const val = currencySelect.value;

                ngnSection.classList.add("d-none");
                kesSection.classList.add("d-none");
                zarSection.classList.add("d-none");

                if (val === "NGN") ngnSection.classList.remove("d-none");
                if (val === "KES") kesSection.classList.remove("d-none");
                if (val === "ZAR") zarSection.classList.remove("d-none");
            }

            enableSplit.addEventListener("change", toggleSplit);
            currencySelect.addEventListener("change", toggleCurrency);

            toggleSplit();
            toggleCurrency();
        });
    </script>
}
