@using BTCPayServer.Abstractions.Contracts
@using BTCPayServer.Abstractions.Extensions
@using BTCPayServer.Abstractions.Models
@using BTCPayServer.Plugins.StoreBridge.ViewModels
@inject IScopeProvider ScopeProvider
@model ImportViewModel
@{
    Layout = "_Layout";
    var storeId = ScopeProvider.GetCurrentStoreId();
    ViewData.SetLayoutModel(new LayoutModel("StoreBridge-Import", "Shopify Bridge - Import") { ActiveCategory = "StoreBridge" });
}

<div class="sticky-header">
    <h2 text-translate="true">@ViewData["Title"]</h2>
    @if (Model.ShowPreview)
    {
        <div class="d-flex gap-3 mt-3 mt-sm-0">
            <button type="submit" form="importConfirmForm" class="btn btn-primary">
                <i class="fa fa-upload me-2"></i>
                Confirm Import
            </button>
            <a asp-action="ImportStore" class="btn btn-secondary">
                <i class="fa fa-times me-2"></i>
                Cancel
            </a>
        </div>
    }
</div>

<partial name="_StatusMessage" />

@if (!Model.ShowPreview)
{
    <!-- STEP 1: UPLOAD FILE -->
    <div class="row">
        <div class="col-xl-8 col-xxl-constrain">
            <p class="mb-4" style="font-size: 1.05rem;">
                Upload a BTCPay store export file to import configuration into this store.
            </p>

            <form method="post" asp-action="ImportStorePreview" enctype="multipart/form-data" class="mb-4">
                <input type="hidden" asp-for="StoreId" />

                <div class="form-group mb-4">
                    <label asp-for="ImportFile" class="form-label">Select Export File</label>
                    <input asp-for="ImportFile"
                           type="file"
                           class="form-control"
                           accept=".btcpayexport"
                           required />
                    <div class="form-text">Only .btcpayexport files are supported (max 10 MB)</div>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fa fa-arrow-right me-2"></i>
                    Next: Preview Import
                </button>
            </form>

            <div class="alert alert-info" role="alert">
                <h6 class="alert-heading">
                    <i class="fa fa-info-circle me-2"></i>
                    About Store Import
                </h6>
                <ul class="mb-0">
                    <li>Import files are encrypted and can only be imported to stores with the correct decryption key</li>
                    <li>You can choose which components to import in the next step</li>
                    <li>Existing configurations will be overwritten with imported data</li>
                    <li>Private keys and passwords are never included in exports</li>
                </ul>
            </div>

            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">How to Import a Store Configuration</h5>
                    <ol class="mb-0">
                        <li class="mb-2"><strong>Upload File:</strong> Select your .btcpayexport file from another BTCPay Server instance</li>
                        <li class="mb-2"><strong>Preview:</strong> Review the export details and select what to import</li>
                        <li class="mb-2"><strong>Confirm:</strong> Complete the import process</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <!-- STEP 2: PREVIEW & SELECT -->
    <div class="row">
        <div class="col-xl-8 col-xxl-constrain">
            <div class="alert alert-success mb-4" role="alert">
                <h6 class="alert-heading">
                    <i class="fa fa-check-circle me-2"></i>
                    Export File Validated
                </h6>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-2"><strong>Exported From:</strong></p>
                        <p class="mb-3 text-muted">@Model.ExportedFrom</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2"><strong>Export Date:</strong></p>
                        <p class="mb-3 text-muted">@Model.FormattedExportDate</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2"><strong>Original Store:</strong></p>
                        <p class="mb-0 text-muted">@Model.OriginalStoreName</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2"><strong>Export Version:</strong></p>
                        <p class="mb-0 text-muted">v@Model.ExportVersion</p>
                    </div>
                </div>
            </div>

            <form method="post" asp-action="ImportStoreConfirm" id="importConfirmForm">
                <input type="hidden" asp-for="StoreId" />

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Select what to import</h5>
                    <small class="text-muted">
                        <span id="selectedCount">@Model.SelectedCount</span> of @Model.AvailableCount items selected
                    </small>
                </div>

                <p class="mb-4" style="font-size: 1.05rem;">
                    Toggle off any items you don't want to import into this store
                </p>

                @if (Model.AvailableOptions.Any())
                {
                    <div class="mb-4">
                        @foreach (var option in Model.AvailableOptions)
                        {
                            var metadata = ImportViewModel.OptionMetadata[option];
                            var isChecked = Model.IsSelected(option);

                            <div class="form-group d-flex align-items-center mb-3" style="padding: 0.5rem 0;">
                                <input type="checkbox"
                                       name="SelectedOptions"
                                       value="@option"
                                       id="import@option"
                                       checked="@isChecked"
                                       class="btcpay-toggle me-3 import-toggle"
                                       style="transform: scale(1.15);" />
                                <label for="import@option" class="mb-0" style="font-size: 1.05rem;">
                                    <strong style="font-size: 1.1rem;">@metadata.Title</strong>
                                    <small class="d-block text-muted" style="font-size: 0.95rem; margin-top: 0.2rem;">@metadata.Description</small>
                                </label>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="alert alert-warning" role="alert">
                        <i class="fa fa-exclamation-triangle me-2"></i>
                        No importable data found in the export file.
                    </div>
                }

                <div class="alert alert-warning mb-4" role="alert">
                    <i class="fa fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> Importing will overwrite existing configurations for the selected options. This action cannot be undone.
                </div>

                <div class="alert alert-info mb-4" role="alert">
                    <i class="fa fa-info-circle me-2"></i>
                    <strong>Note:</strong> Payment methods, webhooks, and apps will be added to your existing configurations. Store settings will be overwritten.
                </div>
            </form>

            <!-- Additional Info Section -->
            <div class="card mt-4">
                <div class="card-body">
                    <h6 class="card-title">Import Details</h6>
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <tbody>
                                <tr>
                                    <td><strong>Current Store:</strong></td>
                                    <td>@Model.StoreId</td>
                                </tr>
                                <tr>
                                    <td><strong>Import Source:</strong></td>
                                    <td>@Model.OriginalStoreName</td>
                                </tr>
                                <tr>
                                    <td><strong>Available Options:</strong></td>
                                    <td>@Model.AvailableCount item(s)</td>
                                </tr>
                                <tr>
                                    <td><strong>Selected Options:</strong></td>
                                    <td><span id="selectedCountDetail">@Model.SelectedCount</span> item(s)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@section PageFootContent {
    @if (Model.ShowPreview)
    {
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const toggles = document.querySelectorAll('.import-toggle');
                const selectedCountSpan = document.getElementById('selectedCount');
                const selectedCountDetailSpan = document.getElementById('selectedCountDetail');

                function updateCount() {
                    const checkedCount = document.querySelectorAll('.import-toggle:checked').length;
                    selectedCountSpan.textContent = checkedCount;
                    selectedCountDetailSpan.textContent = checkedCount;
                }

                toggles.forEach(toggle => {
                    toggle.addEventListener('change', updateCount);
                });

                // Initialize count
                updateCount();
            });
        </script>
    }
}